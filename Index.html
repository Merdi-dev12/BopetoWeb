<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Robot Aspirateur - Contrôle Analogique 360°</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

:root {
--primary: #2563eb;
--primary-dark: #1d4ed8;
--secondary: #0f172a;
--accent: #f59e0b;
--light: #f8fafc;
--gray: #94a3b8;
--success: #10b981;
--danger: #ef4444;
--warning: #f59e0b;
}

body {
background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
color: var(--light);
min-height: 100vh;
padding: 20px;
}

.container {
max-width: 1200px;
margin: 0 auto;
}

header {
text-align: center;
padding: 30px 0;
margin-bottom: 30px;
}

.logo {
display: flex;
align-items: center;
justify-content: center;
gap: 15px;
margin-bottom: 15px;
}

.logo i {
font-size: 2.2rem;
color: var(--accent);
}

.logo h1 {
font-size: 2.5rem;
font-weight: 800;
background: linear-gradient(45deg, var(--accent), var(--primary));
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
background-clip: text;
}

.status-bar {
display: flex;
justify-content: center;
gap: 30px;
margin-top: 20px;
flex-wrap: wrap;
}

.status-item {
background: rgba(30, 41, 59, 0.7);
padding: 12px 20px;
border-radius: 12px;
display: flex;
align-items: center;
gap: 10px;
min-width: 180px;
}

.status-item.battery {
border-left: 4px solid var(--success);
}

.status-item.state {
border-left: 4px solid var(--warning);
}

.status-item.connection {
border-left: 4px solid var(--primary);
}

.status-item i {
font-size: 1.3rem;
}

.card {
background: rgba(15, 23, 42, 0.8);
backdrop-filter: blur(10px);
border-radius: 20px;
padding: 30px;
border: 1px solid rgba(255, 255, 255, 0.1);
box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
margin-bottom: 25px;
}

.card h2 {
font-size: 1.8rem;
margin-bottom: 25px;
color: var(--accent);
display: flex;
align-items: center;
gap: 12px;
}

/* Joystick analogique 360° */
.joystick-360-container {
display: flex;
justify-content: center;
margin: 30px 0;
position: relative;
}

#joystick360 {
width: 280px;
height: 280px;
background: rgba(30, 41, 59, 0.6);
border-radius: 50%;
position: relative;
border: 3px solid rgba(255, 255, 255, 0.2);
box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
cursor: pointer;
}

/* Cercles de repère */
.reference-circle {
position: absolute;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
border: 1px dashed rgba(255, 255, 255, 0.3);
border-radius: 50%;
}

#circle-25 { width: 70px; height: 70px; }
#circle-50 { width: 140px; height: 140px; }
#circle-75 { width: 210px; height: 210px; }

/* Handle du joystick - maintenant mobile et rotatif */
#joystick-handle {
position: absolute;
width: 60px;
height: 60px;
background: linear-gradient(45deg, var(--primary), var(--primary-dark));
border-radius: 50%;
box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4);
cursor: grab;
z-index: 10;
transition: transform 0.1s ease;
display: flex;
align-items: center;
justify-content: center;
color: white;
font-size: 1.2rem;
}

#joystick-handle:active {
cursor: grabbing;
}

/* Indicateur central */
.center-indicator {
position: absolute;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
width: 12px;
height: 12px;
background: var(--accent);
border-radius: 50%;
z-index: 5;
}

/* Curseur de vitesse */
.speed-control {
margin: 30px 0;
padding: 20px;
background: rgba(30, 41, 59, 0.4);
border-radius: 15px;
text-align: center;
}

.speed-control h3 {
margin-bottom: 15px;
color: var(--accent);
font-size: 1.3rem;
}

.speed-slider-container {
max-width: 400px;
margin: 0 auto;
padding: 0 20px;
}

#speedSlider {
width: 100%;
height: 12px;
-webkit-appearance: none;
background: rgba(255, 255, 255, 0.1);
border-radius: 6px;
outline: none;
}

#speedSlider::-webkit-slider-thumb {
-webkit-appearance: none;
width: 28px;
height: 28px;
border-radius: 50%;
background: var(--accent);
cursor: pointer;
box-shadow: 0 0 15px rgba(245, 158, 11, 0.6);
}

.speed-value {
margin-top: 10px;
font-size: 1.4rem;
font-weight: 600;
color: var(--accent);
}

/* Boutons d'aspiration */
.aspiration-controls {
display: flex;
gap: 20px;
justify-content: center;
margin-top: 30px;
flex-wrap: wrap;
}

.aspiration-btn {
padding: 18px 35px;
border: none;
border-radius: 15px;
font-size: 1.2rem;
font-weight: 600;
cursor: pointer;
transition: all 0.3s ease;
display: flex;
align-items: center;
gap: 12px;
min-width: 200px;
}

.start-btn {
background: linear-gradient(45deg, var(--success), #059669);
color: white;
}

.start-btn:hover {
transform: translateY(-3px);
box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
}

.stop-btn {
background: linear-gradient(45deg, var(--danger), #dc2626);
color: white;
}

.stop-btn:hover {
transform: translateY(-3px);
box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
}

.aspiration-btn:active {
transform: translateY(0);
}

/* État d'aspiration */
.aspiration-status {
text-align: center;
padding: 15px;
border-radius: 12px;
margin: 20px 0;
font-weight: 600;
font-size: 1.1rem;
}

.aspiration-status.inactive {
background: rgba(239, 68, 68, 0.2);
color: var(--danger);
border: 2px dashed var(--danger);
}

.aspiration-status.active {
background: rgba(16, 185, 129, 0.2);
color: var(--success);
border: 2px solid var(--success);
}

/* Valeurs analogiques */
.analog-values {
display: flex;
justify-content: center;
gap: 30px;
margin-top: 20px;
flex-wrap: wrap;
}

.value-display {
background: rgba(30, 41, 59, 0.4);
padding: 12px 20px;
border-radius: 12px;
text-align: center;
min-width: 120px;
}

.value-display .label {
font-size: 0.9rem;
color: var(--gray);
margin-bottom: 5px;
}

.value-display .value {
font-size: 1.3rem;
font-weight: 600;
color: var(--accent);
}

/* Notification */
.notification {
position: fixed;
top: 20px;
right: 20px;
padding: 15px 25px;
border-radius: 10px;
color: white;
font-weight: 500;
z-index: 1000;
transform: translateX(200%);
transition: transform 0.3s ease;
}

.notification.show {
transform: translateX(0);
}

.notification.success {
background: var(--success);
}

.notification.error {
background: var(--danger);
}

.notification.info {
background: var(--primary);
}

footer {
text-align: center;
padding: 30px 0;
color: var(--gray);
font-size: 0.9rem;
}

/* Responsive */
@media (max-width: 480px) {
#joystick360 {
width: 220px;
height: 220px;
}

#joystick-handle {
width: 50px;
height: 50px;
font-size: 1rem;
}

.reference-circle {
transform: translate(-50%, -50%) scale(0.8);
}

.aspiration-btn {
min-width: 150px;
padding: 15px 25px;
font-size: 1rem;
}

.speed-slider-container {
padding: 0 10px;
}
}
</style>
</head>
<body>
<div class="container">
<header>
<div class="logo">
<i class="fas fa-robot"></i>
<h1>Bopeto 2.0</h1>
</div>
<div class="status-bar">
<div class="status-item battery" id="batteryStatus">
<i class="fas fa-battery-full"></i>
<span>Batterie: <span id="batteryLevel">85</span>%</span>
</div>
<div class="status-item state" id="robotState">
<i class="fas fa-power-off"></i>
<span>État: Prêt</span>
</div>
<div class="status-item connection">
<i class="fas fa-wifi"></i>
<span>Connecté: ESP32</span>
</div>
</div>
</header>

<div class="card">
<h2><i class="fas fa-circle-notch"></i> Contrôle analogique </h2>

<div class="connection-section">
<div class="aspiration-status inactive" id="aspirationStatus">
<i class="fas fa-fan"></i> Aspiration: Arrêtée
</div>
</div>

<div class="joystick-360-container">
<div id="joystick360">
<!-- Cercles de référence -->
<div class="reference-circle" id="circle-25"></div>
<div class="reference-circle" id="circle-50"></div>
<div class="reference-circle" id="circle-75"></div>

<!-- Indicateur central -->
<div class="center-indicator"></div>

<!-- Handle du joystick mobile et rotatif -->
<div id="joystick-handle">
<i class="fas fa-arrow-up"></i>
</div>
</div>
</div>

<div class="speed-control">
<h3><i class="fas fa-tachometer-alt"></i> Vitesse du Robot</h3>
<div class="speed-slider-container">
<input type="range" min="0" max="100" value="50" class="slider" id="speedSlider">
</div>
<div class="speed-value" id="speedValue">50%</div>
</div>

<div class="analog-values">
<div class="value-display">
<div class="label">Direction</div>
<div class="value" id="directionValue">0°</div>
</div>
<div class="value-display">
<div class="label">Angle</div>
<div class="value" id="angleValue">0°</div>
</div>
<div class="value-display">
<div class="label">Vitesse X</div>
<div class="value" id="xValue">0</div>
</div>
<div class="value-display">
<div class="label">Vitesse Y</div>
<div class="value" id="yValue">0</div>
</div>
</div>

<div class="aspiration-controls">
<button class="aspiration-btn start-btn" id="startAspirationBtn">
<i class="fas fa-play-circle"></i> Démarrer l'aspiration
</button>
<button class="aspiration-btn stop-btn" id="stopAspirationBtn">
<i class="fas fa-stop-circle"></i> Arrêter l'aspiration
</button>
</div>
</div>

<div class="notification" id="notification"></div>

<footer>
<p>Robot Aspirateur ESP32 • Contrôle Analogique 360° Total • © 2024</p>
</footer>
</div>

<script>
// État du système
let isConnected = true;
let isAspirating = false;
let joystickActive = false;
let lastCommandTime = 0;
const COMMAND_INTERVAL = 100; // Envoi de commande toutes les 100ms

// Données simulées du robot
let robotData = {
batteryLevel: 85,
isPoweredOn: true,
lastUpdate: Date.now()
};

// Éléments DOM
const joystick360 = document.getElementById('joystick360');
const joystickHandle = document.getElementById('joystick-handle');
const directionValue = document.getElementById('directionValue');
const angleValue = document.getElementById('angleValue');
const xValue = document.getElementById('xValue');
const yValue = document.getElementById('yValue');
const speedSlider = document.getElementById('speedSlider');
const speedValue = document.getElementById('speedValue');
const startAspirationBtn = document.getElementById('startAspirationBtn');
const stopAspirationBtn = document.getElementById('stopAspirationBtn');
const aspirationStatus = document.getElementById('aspirationStatus');
const notification = document.getElementById('notification');
const batteryLevelElement = document.getElementById('batteryLevel');
const batteryStatusElement = document.getElementById('batteryStatus');
const robotStateElement = document.getElementById('robotState');

// Dimensions du joystick
const joystickRadius = 140; // Rayon du joystick (280px / 2)
const handleRadius = 30; // Rayon du handle (60px / 2)

// Position centrale
let centerX, centerY;

// Initialiser le joystick
function initJoystick() {
const rect = joystick360.getBoundingClientRect();
centerX = rect.left + rect.width / 2;
centerY = rect.top + rect.height / 2;

// Positionner le handle au centre
joystickHandle.style.left = '50%';
joystickHandle.style.top = '50%';
joystickHandle.style.transform = 'translate(-50%, -50%) rotate(0deg)';
}

// Calculer la position et l'angle avec précision 360°
function calculateJoystickValues(clientX, clientY) {
const x = clientX - centerX;
const y = clientY - centerY;

// Distance du centre (0 à joystickRadius)
const distance = Math.min(Math.sqrt(x * x + y * y), joystickRadius - handleRadius);

// Angle en degrés (0° = Nord, 90° = Est, 180° = Sud, 270° = Ouest)
// Conversion pour que 0° soit le Nord (comme une boussole)
let angle = Math.atan2(x, -y) * 180 / Math.PI;
angle = (angle + 360) % 360; // Normaliser entre 0 et 360

// Calculer la position normalisée (-1 à 1) avec l'orientation correcte
const normalizedX = x / (joystickRadius - handleRadius);
const normalizedY = -y / (joystickRadius - handleRadius);

// Appliquer la vitesse
const speedFactor = parseInt(speedSlider.value) / 100;
const finalX = normalizedX * speedFactor;
const finalY = normalizedY * speedFactor;

return { 
x: x, 
y: y, 
angle: angle, 
distance: distance,
normalizedX: finalX,
normalizedY: finalY,
speedFactor: speedFactor
};
}

// Mettre à jour la position ET la rotation du handle
function updateHandlePositionAndRotation(x, y, angle) {
// Calculer la position avec les limites
const maxOffset = joystickRadius - handleRadius;
const clampedX = Math.max(-maxOffset, Math.min(maxOffset, x));
const clampedY = Math.max(-maxOffset, Math.min(maxOffset, y));

// Positionner le handle
joystickHandle.style.left = `calc(50% + ${clampedX}px)`;
joystickHandle.style.top = `calc(50% + ${clampedY}px)`;

// Rotation du handle pour pointer dans la direction du mouvement
// L'icône flèche pointe dans la direction du déplacement
joystickHandle.style.transform = `translate(-50%, -50%) rotate(${angle}deg)`;
}

// Mettre à jour l'affichage
function updateDisplay(angle, normalizedX, normalizedY) {
// Mettre à jour les valeurs affichées (maintenant que des angles)
directionValue.textContent = Math.round(angle) + '°';
angleValue.textContent = Math.round(angle) + '°';
xValue.textContent = (normalizedX * 100).toFixed(0);
yValue.textContent = (normalizedY * 100).toFixed(0);
}

// Envoyer la commande au robot
function sendJoystickCommand(normalizedX, normalizedY, angle) {
const now = Date.now();
if (now - lastCommandTime < COMMAND_INTERVAL) return;

if (!isConnected) {
showNotification('Robot non connecté!', 'error');
return;
}

const speed = parseInt(speedSlider.value);
if (speed < 5) {
// Arrêter le robot si vitesse trop faible
console.log('Commande: MOVE:STOP');
showNotification('Robot arrêté', 'info');
} else {
// Envoyer les valeurs analogiques complètes avec angle 360°
const command = `MOVE_360:${normalizedX.toFixed(2)},${normalizedY.toFixed(2)},${speed},${Math.round(angle)}`;
console.log('Commande:', command);
showNotification(`Déplacement: ${Math.round(angle)}°, Vitesse: ${speed}%`, 'info');
}

lastCommandTime = now;
}

// Gérer le mouvement du joystick
function moveJoystick(clientX, clientY) {
const values = calculateJoystickValues(clientX, clientY);
const { x, y, angle, normalizedX, normalizedY } = values;

// Mettre à jour la position et la rotation du handle
updateHandlePositionAndRotation(x, y, angle);

// Mettre à jour l'affichage
updateDisplay(angle, normalizedX, normalizedY);

// Envoyer la commande
sendJoystickCommand(normalizedX, normalizedY, angle);
}

// Réinitialiser le joystick
function resetJoystick() {
// Remettre le handle au centre avec rotation à 0° (Nord)
joystickHandle.style.left = '50%';
joystickHandle.style.top = '50%';
joystickHandle.style.transform = 'translate(-50%, -50%) rotate(0deg)';

// Mettre à jour l'affichage
updateDisplay(0, 0, 0);

// Envoyer commande d'arrêt
sendJoystickCommand(0, 0, 0);
}

// Mettre à jour l'état du robot (simulé)
function updateRobotStatus() {
// Simuler une légère variation de batterie
if (Math.random() > 0.95) {
robotData.batteryLevel = Math.max(0, Math.min(100, robotData.batteryLevel + (Math.random() > 0.7 ? -1 : 1)));
}

// Mettre à jour l'affichage de la batterie
batteryLevelElement.textContent = robotData.batteryLevel;

// Changer l'icône de batterie selon le niveau
const batteryIcon = document.querySelector('#batteryStatus i');
if (robotData.batteryLevel > 75) {
batteryIcon.className = 'fas fa-battery-full';
batteryStatusElement.style.borderLeft = '4px solid var(--success)';
} else if (robotData.batteryLevel > 30) {
batteryIcon.className = 'fas fa-battery-three-quarters';
batteryStatusElement.style.borderLeft = '4px solid var(--warning)';
} else {
batteryIcon.className = 'fas fa-battery-quarter';
batteryStatusElement.style.borderLeft = '4px solid var(--danger)';
}

// Mettre à jour l'état du robot
const stateText = document.querySelector('#robotState span:last-child');
const stateIcon = document.querySelector('#robotState i');
if (robotData.isPoweredOn) {
stateText.textContent = 'Prêt';
stateIcon.className = 'fas fa-power-off';
robotStateElement.style.borderLeft = '4px solid var(--warning)';
} else {
stateText.textContent = 'Éteint';
stateIcon.className = 'fas fa-power-off';
robotStateElement.style.borderLeft = '4px solid var(--danger)';
}
}

// Fonction pour afficher les notifications
function showNotification(message, type = 'success') {
notification.textContent = message;
notification.className = `notification ${type} show`;
setTimeout(() => {
notification.classList.remove('show');
}, 3000);
}

// Mise à jour de l'état d'aspiration
function updateAspirationStatus() {
if (isAspirating) {
aspirationStatus.className = 'aspiration-status active';
aspirationStatus.innerHTML = '<i class="fas fa-fan"></i> Aspiration: En cours';
} else {
aspirationStatus.className = 'aspiration-status inactive';
aspirationStatus.innerHTML = '<i class="fas fa-fan"></i> Aspiration: Arrêtée';
}
}

// Gestion de l'aspiration
startAspirationBtn.addEventListener('click', () => {
if (!isAspirating) {
isAspirating = true;
updateAspirationStatus();
if (isConnected) {
console.log('Commande: ASPIRATION:START');
showNotification('Aspiration démarrée!', 'success');
}
}
});

stopAspirationBtn.addEventListener('click', () => {
if (isAspirating) {
isAspirating = false;
updateAspirationStatus();
if (isConnected) {
console.log('Commande: ASPIRATION:STOP');
showNotification('Aspiration arrêtée!', 'warning');
}
}
});

// Gestion du curseur de vitesse
speedSlider.addEventListener('input', () => {
const value = speedSlider.value;
speedValue.textContent = value + '%';

// Si le joystick est actif, envoyer une nouvelle commande avec la nouvelle vitesse
if (joystickActive) {
const rect = joystick360.getBoundingClientRect();
const handleRect = joystickHandle.getBoundingClientRect();
const currentClientX = handleRect.left + handleRect.width / 2;
const currentClientY = handleRect.top + handleRect.height / 2;
moveJoystick(currentClientX, currentClientY);
}
});

// Événements du joystick
joystick360.addEventListener('mousedown', (e) => {
joystickActive = true;
moveJoystick(e.clientX, e.clientY);
});

joystick360.addEventListener('touchstart', (e) => {
joystickActive = true;
e.preventDefault();
moveJoystick(e.touches[0].clientX, e.touches[0].clientY);
});

document.addEventListener('mousemove', (e) => {
if (joystickActive) {
moveJoystick(e.clientX, e.clientY);
}
});

document.addEventListener('touchmove', (e) => {
if (joystickActive) {
e.preventDefault();
moveJoystick(e.touches[0].clientX, e.touches[0].clientY);
}
});

document.addEventListener('mouseup', () => {
if (joystickActive) {
joystickActive = false;
resetJoystick();
}
});

document.addEventListener('touchend', () => {
if (joystickActive) {
joystickActive = false;
resetJoystick();
}
});

// Initialisation
window.addEventListener('load', () => {
initJoystick();
updateAspirationStatus();
showNotification('Contrôle analogique 360° total prêt!', 'info');

// Mettre à jour le statut du robot toutes les 2 secondes (simulé)
setInterval(updateRobotStatus, 2000);
updateRobotStatus(); // Mise à jour initiale
});

// Recalculer le centre si la fenêtre est redimensionnée
window.addEventListener('resize', initJoystick);
</script>
</body>
</html>